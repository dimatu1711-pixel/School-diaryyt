function addClass() {
    const grade = document.getElementById('classGrade').value;
    const letter = document.getElementById('classLetter').value;
    const teacherId = document.getElementById('classTeacher').value;
    
    if (grade && letter && teacherId) {
        const teacher = schoolData.teachers.find(t => t.id == teacherId);
        const newClass = {
            id: Date.now(),
            name: `${grade}-${letter}`,
            grade: grade,
            letter: letter,
            teacher: teacher.name,
            teacherId: parseInt(teacherId), // –ü—Ä–∞–≤–∏–ª—å–Ω–æ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ teacherId
            students: [],
            teachers: [] // –ú–∞—Å–∏–≤ –¥–ª—è –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –≤—á–∏—Ç–µ–ª—ñ–≤
        };
        
        schoolData.classes.push(newClass);
        saveSchoolData();
        loadClasses();
        populateClassSelect();
        populateClassForScheduleSelect();
        populateGPTClassSelect();
        updateStats();
        
        document.getElementById('classGrade').value = '';
        document.getElementById('classLetter').value = '';
        document.getElementById('classTeacher').value = '';
    } else {
        alert('‚ùå –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è!');
    }
}

// –û–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—á–∏—Ç–µ–ª—ñ–≤ –∫–ª–∞—Å—É
function loadClassTeachers(classId) {
    const classItem = schoolData.classes.find(c => c.id == classId);
    const teachersList = document.getElementById('classTeachersList');
    const teacherSelect = document.getElementById('teacherToAdd');
    
    if (!classItem) return;
    
    // –û–Ω–æ–≤–ª—é—î–º–æ –≤–∏–±—ñ—Ä –≤—á–∏—Ç–µ–ª—ñ–≤
    teacherSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –≤—á–∏—Ç–µ–ª—è</option>';
    
    schoolData.teachers.forEach(teacher => {
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤—á–∏—Ç–µ–ª—å –≤–∂–µ –¥–æ–¥–∞–Ω–∏–π –∞–±–æ —Ü–µ –∫–ª–∞—Å–Ω–∏–π –∫–µ—Ä—ñ–≤–Ω–∏–∫
        const isAlreadyAdded = classItem.teachers && classItem.teachers.includes(teacher.id);
        const isHeadTeacher = classItem.teacherId === teacher.id;
        
        if (!isAlreadyAdded && !isHeadTeacher) {
            const option = document.createElement('option');
            option.value = teacher.id;
            option.textContent = `${teacher.name} (${teacher.subject})`;
            teacherSelect.appendChild(option);
        }
    });
    
    // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ –≤—á–∏—Ç–µ–ª—ñ–≤ –∫–ª–∞—Å—É
    teachersList.innerHTML = '';
    
    // –î–æ–¥–∞—î–º–æ –∫–ª–∞—Å–Ω–æ–≥–æ –∫–µ—Ä—ñ–≤–Ω–∏–∫–∞
    if (classItem.teacherId) {
        const headTeacher = schoolData.teachers.find(t => t.id == classItem.teacherId);
        if (headTeacher) {
            const item = document.createElement('div');
            item.className = 'student-item';
            item.innerHTML = `
                <div>
                    <strong>${headTeacher.name}</strong><br>
                    <small>${headTeacher.email} | ${headTeacher.subject}</small>
                </div>
                <div>
                    <span class="head-teacher-badge">üëë –ö–ª–∞—Å–Ω–∏–π –∫–µ—Ä—ñ–≤–Ω–∏–∫</span>
                </div>
            `;
            teachersList.appendChild(item);
        }
    }
    
    // –î–æ–¥–∞—î–º–æ —ñ–Ω—à–∏—Ö –≤—á–∏—Ç–µ–ª—ñ–≤
    if (classItem.teachers && classItem.teachers.length > 0) {
        classItem.teachers.forEach(teacherId => {
            const teacher = schoolData.teachers.find(t => t.id == teacherId);
            if (teacher) {
                const item = document.createElement('div');
                item.className = 'student-item';
                item.innerHTML = `
                    <div>
                        <strong>${teacher.name}</strong><br>
                        <small>${teacher.email} | ${teacher.subject}</small>
                    </div>
                    <div>
                        <button class="btn-small" style="background: #ff6b6b;" onclick="removeTeacherFromClass(${teacherId}, ${classId})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                    </div>
                `;
                teachersList.appendChild(item);
            }
        });
    } else {
        const noTeachersMsg = document.createElement('div');
        noTeachersMsg.innerHTML = '<p style="text-align: center; color: #666; padding: 10px;">üë®‚Äçüè´ –ñ–æ–¥–Ω–æ–≥–æ –¥–æ–¥–∞—Ç–∫–æ–≤–æ–≥–æ –≤—á–∏—Ç–µ–ª—è —â–µ –Ω–µ –¥–æ–¥–∞–Ω–æ</p>';
        teachersList.appendChild(noTeachersMsg);
    }
}

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≤—á–∏—Ç–µ–ª—è –¥–æ –∫–ª–∞—Å—É
function addTeacherToClass() {
    if (!currentClassId) {
        alert('‚ùå –°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –∫–ª–∞—Å!');
        return;
    }
    
    const teacherSelect = document.getElementById('teacherToAdd');
    const teacherId = parseInt(teacherSelect.value);
    
    if (!teacherId) {
        alert('‚ùå –û–±–µ—Ä—ñ—Ç—å –≤—á–∏—Ç–µ–ª—è –∑—ñ —Å–ø–∏—Å–∫—É!');
        return;
    }
    
    const classItem = schoolData.classes.find(c => c.id == currentClassId);
    
    if (!classItem) {
        alert('‚ùå –ö–ª–∞—Å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!');
        return;
    }
    
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –º–∞—Å–∏–≤ teachers —è–∫—â–æ –π–æ–≥–æ –Ω–µ–º–∞—î
    if (!classItem.teachers) {
        classItem.teachers = [];
    }
    
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤—á–∏—Ç–µ–ª—å –≤–∂–µ –¥–æ–¥–∞–Ω–∏–π
    if (classItem.teachers.includes(teacherId) || teacherId === classItem.teacherId) {
        alert('‚ùå –¶–µ–π –≤—á–∏—Ç–µ–ª—å –≤–∂–µ –º–∞—î –¥–æ—Å—Ç—É–ø –¥–æ –∫–ª–∞—Å—É!');
        teacherSelect.value = '';
        return;
    }
    
    // –î–æ–¥–∞—î–º–æ –≤—á–∏—Ç–µ–ª—è
    classItem.teachers.push(teacherId);
    saveSchoolData();
    loadClassTeachers(currentClassId);
    
    alert('‚úÖ –í—á–∏—Ç–µ–ª—è —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ –¥–æ –∫–ª–∞—Å—É!');
    teacherSelect.value = '';
}

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è –≤—á–∏—Ç–µ–ª—è –∑ –∫–ª–∞—Å—É
function removeTeacherFromClass(teacherId, classId) {
    if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –¥–æ—Å—Ç—É–ø —Ü—å–æ–≥–æ –≤—á–∏—Ç–µ–ª—è –¥–æ –∫–ª–∞—Å—É?')) {
        const classItem = schoolData.classes.find(c => c.id == classId);
        
        if (!classItem || !classItem.teachers) return;
        
        // –í–∏–¥–∞–ª—è—î–º–æ –≤—á–∏—Ç–µ–ª—è –∑ –º–∞—Å–∏–≤—É
        classItem.teachers = classItem.teachers.filter(id => id !== teacherId);
        saveSchoolData();
        loadClassTeachers(classId);
        
        alert('‚úÖ –î–æ—Å—Ç—É–ø –≤—á–∏—Ç–µ–ª—è –≤–∏–¥–∞–ª–µ–Ω–æ!');
    }
}

// –û–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –≤–∫–ª–∞–¥–∫–∏ –∫–ª–∞—Å—É
function openClassTab(tabName) {
    // –•–æ–≤–∞—î–º–æ –≤—Å—ñ –≤–∫–ª–∞–¥–∫–∏
    document.querySelectorAll('.class-tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.class-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // –ü–æ–∫–∞–∑—É—î–º–æ –æ–±—Ä–∞–Ω—É –≤–∫–ª–∞–¥–∫—É
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
    
    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
    if (tabName === 'classSchedule') {
        loadClassSchedule(currentClassId);
    } else if (tabName === 'classTeachers') {
        loadClassTeachers(currentClassId);
    }
}

// –û–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è populateTeacherSelect –¥–ª—è –≤–∏–±–æ—Ä—É –≤—á–∏—Ç–µ–ª—è –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –∫–ª–∞—Å—É
function populateTeacherSelect() {
    const select = document.getElementById('classTeacher');
    select.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –≤—á–∏—Ç–µ–ª—è</option>';
    
    schoolData.teachers.forEach(teacher => {
        const option = document.createElement('option');
        option.value = teacher.id;
        option.textContent = `${teacher.name} (${teacher.subject})`;
        select.appendChild(option);
    });
}

// –î–æ–¥–∞—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–∞–Ω–∏—Ö
function checkSchoolData() {
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤—Å—ñ –∫–ª–∞—Å–∏ –º–∞—é—Ç—å teacherId
    schoolData.classes.forEach(classItem => {
        if (!classItem.teacherId && classItem.teacher) {
            // –°–ø—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ teacherId –∑–∞ —ñ–º–µ–Ω–µ–º
            const foundTeacher = schoolData.teachers.find(t => t.name === classItem.teacher);
            if (foundTeacher) {
                classItem.teacherId = foundTeacher.id;
            }
        }
        
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –º–∞—Å–∏–≤ teachers —è–∫—â–æ –π–æ–≥–æ –Ω–µ–º–∞—î
        if (!classItem.teachers) {
            classItem.teachers = [];
        }
    });
    
    saveSchoolData();
}

// –í–∏–∫–ª–∏–∫–∞—î–º–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
document.addEventListener('DOMContentLoaded', function() {
    checkSchoolData(); // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ç–∞ –≤–∏–ø—Ä–∞–≤–ª—è—î–º–æ –¥–∞–Ω—ñ
    updateSchoolTitle();
    updateStats();
    loadTeachers();
    loadClasses();
    loadAdmins();
    loadAllStudents();
    populateTeacherSelect();
    populateClassSelect();
    populateClassForScheduleSelect();
    populateGPTClassSelect();
    loadSubjects();
});
